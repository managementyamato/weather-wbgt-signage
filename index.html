<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Â§©Ê∞ó„ÉªÊöë„ÅïÊåáÊï∞„É¢„Éã„Çø„Éº</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #f5f7fa;
            --bg-card: #ffffff;
            --text-primary: #1a1a2e;
            --text-secondary: #64748b;
            --border-color: #e2e8f0;
            --danger: #dc2626;
            --warning: #ea580c;
            --caution: #ca8a04;
            --attention: #16a34a;
            --safe: #2563eb;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            height: 100%;
            overflow: hidden;
        }

        body {
            font-family: 'Noto Sans JP', sans-serif;
            background: var(--bg-card);
            color: var(--text-primary);
        }

        .container {
            width: 100%;
            height: 100%;
        }

        .card {
            background: var(--bg-card);
            height: 100%;
            display: flex;
            flex-direction: column;
            padding: 3vh 4vw;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 2vh;
            border-bottom: 2px solid var(--border-color);
            flex-shrink: 0;
        }

        .title {
            font-size: clamp(1.2rem, 3vw, 2rem);
            font-weight: 700;
            color: var(--text-primary);
        }

        .location {
            font-size: clamp(1rem, 2.5vw, 1.8rem);
            color: var(--text-secondary);
            background: var(--bg-primary);
            padding: 1vh 2vw;
            border-radius: 8px;
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: row;
            gap: 4vw;
            padding: 2vh 0;
            min-height: 0;
        }

        .weather-section {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 3vw;
            border-right: 2px solid var(--border-color);
            padding-right: 4vw;
        }

        .weather-icon {
            font-size: clamp(4rem, 12vw, 10rem);
        }

        .weather-info {
            text-align: left;
        }

        .weather-temp {
            font-size: clamp(3rem, 10vw, 8rem);
            font-weight: 900;
            line-height: 1;
        }

        .weather-desc {
            font-size: clamp(1rem, 3vw, 2.5rem);
            color: var(--text-secondary);
            margin-top: 1vh;
        }

        .weather-details {
            display: flex;
            gap: 2vw;
            margin-top: 1.5vh;
            font-size: clamp(0.9rem, 2vw, 1.8rem);
            color: var(--text-secondary);
        }

        .weather-detail {
            display: flex;
            align-items: center;
            gap: 0.5vw;
        }

        .wbgt-section-wrapper {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .value-section {
            text-align: center;
        }

        .value-label {
            font-size: clamp(1rem, 2vw, 1.8rem);
            color: var(--text-secondary);
            margin-bottom: 1vh;
            letter-spacing: 0.5px;
        }

        .value-container {
            display: flex;
            align-items: baseline;
            justify-content: center;
            gap: 0.5vw;
        }

        .value {
            font-size: clamp(4rem, 12vw, 10rem);
            font-weight: 900;
            line-height: 1;
            transition: color 0.3s ease;
        }

        .unit {
            font-size: clamp(1.5rem, 4vw, 3rem);
            font-weight: 500;
            color: var(--text-secondary);
        }

        .status {
            text-align: center;
            padding: 2vh 2vw;
            border-radius: 12px;
            margin-top: 2vh;
            font-weight: 700;
            transition: all 0.3s ease;
        }

        .status.danger {
            background: rgba(220, 38, 38, 0.15);
            color: var(--danger);
            border: 3px solid var(--danger);
        }

        .status.warning {
            background: rgba(234, 88, 12, 0.15);
            color: var(--warning);
            border: 3px solid var(--warning);
        }

        .status.caution {
            background: rgba(202, 138, 4, 0.15);
            color: var(--caution);
            border: 3px solid var(--caution);
        }

        .status.attention {
            background: rgba(22, 163, 74, 0.15);
            color: var(--attention);
            border: 3px solid var(--attention);
        }

        .status.safe {
            background: rgba(37, 99, 235, 0.15);
            color: var(--safe);
            border: 3px solid var(--safe);
        }

        .status-main {
            font-size: clamp(1.5rem, 4vw, 3rem);
            margin-bottom: 0.5vh;
        }

        .status-sub {
            font-size: clamp(1rem, 2.5vw, 2rem);
            font-weight: 500;
            opacity: 0.9;
        }

        .guide {
            padding-top: 2vh;
            border-top: 2px solid var(--border-color);
            flex-shrink: 0;
        }

        .guide-title {
            font-size: clamp(0.9rem, 1.5vw, 1.4rem);
            color: var(--text-secondary);
            margin-bottom: 1.5vh;
            text-align: center;
        }

        .guide-items {
            display: flex;
            justify-content: space-between;
            gap: 1vw;
        }

        .guide-item {
            flex: 1;
            text-align: center;
            padding: 1.5vh 1vw;
            border-radius: 8px;
            background: var(--bg-primary);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .guide-item.active {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .guide-level {
            font-size: clamp(0.8rem, 1.5vw, 1.3rem);
            font-weight: 700;
            margin-bottom: 0.5vh;
        }

        .guide-level.danger { color: var(--danger); }
        .guide-level.warning { color: var(--warning); }
        .guide-level.caution { color: var(--caution); }
        .guide-level.attention { color: var(--attention); }
        .guide-level.safe { color: var(--safe); }

        .guide-range {
            font-size: clamp(0.7rem, 1.2vw, 1.1rem);
            color: var(--text-secondary);
        }

        .footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 2vh;
            border-top: 2px solid var(--border-color);
            font-size: clamp(0.9rem, 1.5vw, 1.3rem);
            color: var(--text-secondary);
            flex-shrink: 0;
        }

        .update-time {
            display: flex;
            align-items: center;
            gap: 1vw;
        }

        .status-dot {
            width: clamp(10px, 1vw, 16px);
            height: clamp(10px, 1vw, 16px);
            border-radius: 50%;
            background: var(--attention);
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-primary);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 1;
            visibility: visible;
            transition: opacity 0.4s ease, visibility 0.4s ease;
        }

        .loading-overlay.hidden {
            opacity: 0;
            visibility: hidden;
        }

        .loading-spinner {
            width: 48px;
            height: 48px;
            border: 3px solid var(--border-color);
            border-top-color: var(--text-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 16px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .error-message {
            background: rgba(220, 38, 38, 0.1);
            border: 1px solid var(--danger);
            color: var(--danger);
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 16px;
            font-size: 0.85rem;
            display: none;
        }

        .error-message.show {
            display: block;
        }

        .debug-info {
            background: var(--bg-primary);
            padding: 12px;
            border-radius: 8px;
            margin-top: 8px;
            font-size: 0.75rem;
            color: var(--text-secondary);
            word-break: break-all;
        }

        /* Á∏¶Âêë„ÅçÁîªÈù¢ - ‰∏ä‰∏ã„Å´ÈÖçÁΩÆ */
        @media (orientation: portrait) {
            .main-content {
                flex-direction: column;
                gap: 2vh;
            }
            .weather-section {
                border-right: none;
                border-bottom: 2px solid var(--border-color);
                padding-right: 0;
                padding-bottom: 2vh;
            }
            .wbgt-section-wrapper {
                flex: 1;
            }
        }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <div class="loading-text">ÁèæÂú®Âú∞„ÇíÂèñÂæó‰∏≠...</div>
    </div>

    <div class="container">
        <div class="card">
            <div class="error-message" id="errorMessage">
                <div id="errorText"></div>
                <div class="debug-info" id="debugInfo"></div>
            </div>

            <div class="header">
                <div class="title">Â§©Ê∞ó„ÉªÊöë„ÅïÊåáÊï∞„É¢„Éã„Çø„Éº</div>
                <div class="location" id="location">ÂèñÂæó‰∏≠...</div>
            </div>

            <div class="main-content">
                <div class="weather-section">
                    <div class="weather-icon" id="weatherIcon">--</div>
                    <div class="weather-info">
                        <div class="weather-temp"><span id="weatherTemp">--</span>‚ÑÉ</div>
                        <div class="weather-desc" id="weatherDesc">--</div>
                        <div class="weather-details">
                            <div class="weather-detail">
                                <span>ÈôçÊ∞¥Á¢∫Áéá</span>
                                <span id="weatherPop">--%</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="wbgt-section-wrapper">
                    <div class="value-section" id="wbgtSection">
                        <div class="value-label">Êöë„ÅïÊåáÊï∞ (WBGT)</div>
                        <div class="value-container">
                            <span class="value" id="wbgtValue">--</span>
                            <span class="unit">‚ÑÉ</span>
                        </div>
                    </div>

                    <div class="status safe" id="status">
                        <div class="status-main" id="statusMain">--</div>
                        <div class="status-sub" id="statusSub">--</div>
                    </div>
                </div>
            </div>

            <div class="guide" id="guideSection">
                <div class="guide-title">Êöë„ÅïÊåáÊï∞„É¨„Éô„É´</div>
                <div class="guide-items">
                    <div class="guide-item" data-level="danger">
                        <div class="guide-level danger">Âç±Èô∫</div>
                        <div class="guide-range">31‚ÑÉ‰ª•‰∏ä</div>
                    </div>
                    <div class="guide-item" data-level="warning">
                        <div class="guide-level warning">Âé≥ÈáçË≠¶Êàí</div>
                        <div class="guide-range">28-31‚ÑÉ</div>
                    </div>
                    <div class="guide-item" data-level="caution">
                        <div class="guide-level caution">Ë≠¶Êàí</div>
                        <div class="guide-range">25-28‚ÑÉ</div>
                    </div>
                    <div class="guide-item" data-level="attention">
                        <div class="guide-level attention">Ê≥®ÊÑè</div>
                        <div class="guide-range">21-25‚ÑÉ</div>
                    </div>
                    <div class="guide-item" data-level="safe">
                        <div class="guide-level safe">„Åª„ÅºÂÆâÂÖ®</div>
                        <div class="guide-range">21‚ÑÉÊú™Ê∫Ä</div>
                    </div>
                </div>
            </div>

            <div class="footer">
                <div class="update-time">
                    <div class="status-dot" id="statusDot"></div>
                    <span>ÊúÄÁµÇÊõ¥Êñ∞: <span id="lastUpdate">--:--</span></span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // API URLs
        var WBGT_API_BASE = 'https://wbgt-api-server-422283659205.asia-northeast1.run.app';

        // Open-Meteo WMO Weather Code mapping
        var WMO_WEATHER = {
            0: { icon: "‚òÄÔ∏è", desc: "Âø´Êô¥" },
            1: { icon: "üå§Ô∏è", desc: "Êô¥„Çå" },
            2: { icon: "‚õÖ", desc: "„Åè„ÇÇ„Çä" },
            3: { icon: "‚òÅÔ∏è", desc: "„Åè„ÇÇ„Çä" },
            45: { icon: "üå´Ô∏è", desc: "Èúß" },
            48: { icon: "üå´Ô∏è", desc: "ÈúßÊ∞∑" },
            51: { icon: "üåßÔ∏è", desc: "Â∞èÈõ®" },
            53: { icon: "üåßÔ∏è", desc: "Èõ®" },
            55: { icon: "üåßÔ∏è", desc: "Âº∑„ÅÑÈõ®" },
            56: { icon: "üåßÔ∏è", desc: "ÂáçÈõ®" },
            57: { icon: "üåßÔ∏è", desc: "ÂáçÈõ®" },
            61: { icon: "üåßÔ∏è", desc: "Â∞èÈõ®" },
            63: { icon: "üåßÔ∏è", desc: "Èõ®" },
            65: { icon: "üåßÔ∏è", desc: "Âº∑„ÅÑÈõ®" },
            66: { icon: "üåßÔ∏è", desc: "ÂáçÈõ®" },
            67: { icon: "üåßÔ∏è", desc: "ÂáçÈõ®" },
            71: { icon: "üå®Ô∏è", desc: "Â∞èÈõ™" },
            73: { icon: "üå®Ô∏è", desc: "Èõ™" },
            75: { icon: "üå®Ô∏è", desc: "Â§ßÈõ™" },
            77: { icon: "üå®Ô∏è", desc: "ÈúßÈõ™" },
            80: { icon: "üå¶Ô∏è", desc: "„Å´„Çè„ÅãÈõ®" },
            81: { icon: "üåßÔ∏è", desc: "„Å´„Çè„ÅãÈõ®" },
            82: { icon: "‚õàÔ∏è", desc: "ÊøÄ„Åó„ÅÑ„Å´„Çè„ÅãÈõ®" },
            85: { icon: "üå®Ô∏è", desc: "„Å´„Çè„ÅãÈõ™" },
            86: { icon: "üå®Ô∏è", desc: "„Å´„Çè„ÅãÈõ™" },
            95: { icon: "‚õàÔ∏è", desc: "Èõ∑Èõ®" },
            96: { icon: "‚õàÔ∏è", desc: "Èõ∑Èõ®ÔºàÈõπÔºâ" },
            99: { icon: "‚õàÔ∏è", desc: "Èõ∑Èõ®ÔºàÂ§ßÁ≤í„ÅÆÈõπÔºâ" }
        };

        // Ë¶≥Ê∏¨Âú∞ÁÇπ„Éá„Éº„Çø
        var OBSERVATION_POINTS = {
            "ÂåóÊµ∑ÈÅì": {
                "ÂÆóË∞∑": [{ code: "11016", name: "Á®öÂÜÖ", lat: 45.4167, lon: 141.6833 }],
                "‰∏äÂ∑ù": [{ code: "12442", name: "Êó≠Â∑ù", lat: 43.7667, lon: 142.3667 }],
                "Áü≥Áã©": [{ code: "14163", name: "Êú≠Âπå", lat: 43.0608, lon: 141.3544 }],
                "Ê∏°Â≥∂": [{ code: "15041", name: "ÂáΩÈ§®", lat: 41.8167, lon: 140.7500 }]
            },
            "Êù±Âåó": {
                "ÈùíÊ£ÆÁúå": [{ code: "31312", name: "ÈùíÊ£Æ", lat: 40.8222, lon: 140.7472 }],
                "Â≤©ÊâãÁúå": [{ code: "33472", name: "ÁõõÂ≤°", lat: 39.7000, lon: 141.1667 }],
                "ÂÆÆÂüéÁúå": [{ code: "34392", name: "‰ªôÂè∞", lat: 38.2667, lon: 140.8667 }],
                "ÁßãÁî∞Áúå": [{ code: "32402", name: "ÁßãÁî∞", lat: 39.7167, lon: 140.1000 }],
                "Â±±ÂΩ¢Áúå": [{ code: "35426", name: "Â±±ÂΩ¢", lat: 38.2556, lon: 140.3389 }],
                "Á¶èÂ≥∂Áúå": [{ code: "36126", name: "Á¶èÂ≥∂", lat: 37.7500, lon: 140.4667 }]
            },
            "Èñ¢Êù±": {
                "Ëå®ÂüéÁúå": [{ code: "40201", name: "Ê∞¥Êà∏", lat: 36.3667, lon: 140.4667 }],
                "Ê†ÉÊú®Áúå": [{ code: "41277", name: "ÂÆáÈÉΩÂÆÆ", lat: 36.5500, lon: 139.8667 }],
                "Áæ§È¶¨Áúå": [{ code: "42251", name: "ÂâçÊ©ã", lat: 36.3833, lon: 139.0667 }],
                "ÂüºÁéâÁúå": [{ code: "43056", name: "„Åï„ÅÑ„Åü„Åæ", lat: 35.8617, lon: 139.6453 }],
                "ÂçÉËëâÁúå": [{ code: "45147", name: "ÂçÉËëâ", lat: 35.6000, lon: 140.1000 }],
                "Êù±‰∫¨ÈÉΩ": [{ code: "44132", name: "Êù±‰∫¨", lat: 35.6895, lon: 139.6917 }],
                "Á•ûÂ•àÂ∑ùÁúå": [{ code: "46106", name: "Ê®™Êµú", lat: 35.4500, lon: 139.6500 }]
            },
            "ÂåóÈô∏": {
                "Êñ∞ÊΩüÁúå": [{ code: "54232", name: "Êñ∞ÊΩü", lat: 37.9167, lon: 139.0500 }],
                "ÂØåÂ±±Áúå": [{ code: "55102", name: "ÂØåÂ±±", lat: 36.7000, lon: 137.2167 }],
                "Áü≥Â∑ùÁúå": [{ code: "56227", name: "ÈáëÊ≤¢", lat: 36.5944, lon: 136.6256 }],
                "Á¶è‰∫ïÁúå": [{ code: "57066", name: "Á¶è‰∫ï", lat: 36.0667, lon: 136.2167 }]
            },
            "‰∏≠ÈÉ®": {
                "Â±±Ê¢®Áúå": [{ code: "49142", name: "Áî≤Â∫ú", lat: 35.6667, lon: 138.5500 }],
                "Èï∑ÈáéÁúå": [{ code: "48331", name: "Èï∑Èáé", lat: 36.6500, lon: 138.1833 }],
                "Â≤êÈòúÁúå": [{ code: "52586", name: "Â≤êÈòú", lat: 35.4167, lon: 136.7500 }],
                "ÈùôÂ≤°Áúå": [{ code: "50331", name: "ÈùôÂ≤°", lat: 34.9833, lon: 138.3833 }],
                "ÊÑõÁü•Áúå": [{ code: "51106", name: "ÂêçÂè§Â±ã", lat: 35.1667, lon: 136.9667 }]
            },
            "ËøëÁïø": {
                "‰∏âÈáçÁúå": [{ code: "53133", name: "Ê¥•", lat: 34.7333, lon: 136.5167 }],
                "ÊªãË≥ÄÁúå": [{ code: "60131", name: "ÂΩ¶Ê†π", lat: 35.2667, lon: 136.2500 }],
                "‰∫¨ÈÉΩÂ∫ú": [{ code: "61286", name: "‰∫¨ÈÉΩ", lat: 35.0167, lon: 135.7333 }],
                "Â§ßÈò™Â∫ú": [{ code: "62078", name: "Â§ßÈò™", lat: 34.6833, lon: 135.5167 }],
                "ÂÖµÂ∫´Áúå": [{ code: "63518", name: "Á•ûÊà∏", lat: 34.6913, lon: 135.1830 }],
                "Â•àËâØÁúå": [{ code: "64036", name: "Â•àËâØ", lat: 34.6833, lon: 135.8333 }],
                "ÂíåÊ≠åÂ±±Áúå": [{ code: "65042", name: "ÂíåÊ≠åÂ±±", lat: 34.2333, lon: 135.1667 }]
            },
            "‰∏≠ÂõΩ": {
                "È≥•ÂèñÁúå": [{ code: "69122", name: "È≥•Âèñ", lat: 35.5000, lon: 134.2333 }],
                "Â≥∂Ê†πÁúå": [{ code: "68132", name: "ÊùæÊ±ü", lat: 35.4667, lon: 133.0500 }],
                "Â≤°Â±±Áúå": [{ code: "66408", name: "Â≤°Â±±", lat: 34.6500, lon: 133.9167 }],
                "Â∫ÉÂ≥∂Áúå": [{ code: "67437", name: "Â∫ÉÂ≥∂", lat: 34.3833, lon: 132.4500 }],
                "Â±±Âè£Áúå": [{ code: "81428", name: "‰∏ãÈñ¢", lat: 33.9500, lon: 130.9333 }]
            },
            "ÂõõÂõΩ": {
                "Âæ≥Â≥∂Áúå": [{ code: "71106", name: "Âæ≥Â≥∂", lat: 34.0667, lon: 134.5500 }],
                "È¶ôÂ∑ùÁúå": [{ code: "72086", name: "È´òÊùæ", lat: 34.3167, lon: 134.0500 }],
                "ÊÑõÂ™õÁúå": [{ code: "73166", name: "ÊùæÂ±±", lat: 33.8333, lon: 132.7833 }],
                "È´òÁü•Áúå": [{ code: "74181", name: "È´òÁü•", lat: 33.5500, lon: 133.5333 }]
            },
            "‰πùÂ∑û": {
                "Á¶èÂ≤°Áúå": [{ code: "82182", name: "Á¶èÂ≤°", lat: 33.5833, lon: 130.3833 }],
                "‰ΩêË≥ÄÁúå": [{ code: "85142", name: "‰ΩêË≥Ä", lat: 33.2500, lon: 130.3000 }],
                "Èï∑Â¥éÁúå": [{ code: "84496", name: "Èï∑Â¥é", lat: 32.7333, lon: 129.8667 }],
                "ÁÜäÊú¨Áúå": [{ code: "86141", name: "ÁÜäÊú¨", lat: 32.8000, lon: 130.7000 }],
                "Â§ßÂàÜÁúå": [{ code: "83216", name: "Â§ßÂàÜ", lat: 33.2333, lon: 131.6167 }],
                "ÂÆÆÂ¥éÁúå": [{ code: "87376", name: "ÂÆÆÂ¥é", lat: 31.9333, lon: 131.4167 }],
                "ÈπøÂÖêÂ≥∂Áúå": [{ code: "88317", name: "ÈπøÂÖêÂ≥∂", lat: 31.5667, lon: 130.5500 }]
            },
            "Ê≤ñÁ∏Ñ": {
                "Ê≤ñÁ∏ÑÁúå": [{ code: "91197", name: "ÈÇ£Ë¶á", lat: 26.2167, lon: 127.6833 }]
            }
        };

        // DOM Elements - script is at end of body so DOM is ready
        var loadingOverlay = document.getElementById('loadingOverlay');
        var wbgtValue = document.getElementById('wbgtValue');
        var wbgtSection = document.getElementById('wbgtSection');
        var guideSection = document.getElementById('guideSection');
        var locationEl = document.getElementById('location');
        var statusEl = document.getElementById('status');
        var statusMain = document.getElementById('statusMain');
        var statusSub = document.getElementById('statusSub');
        var lastUpdate = document.getElementById('lastUpdate');
        var statusDot = document.getElementById('statusDot');
        var guideItems = document.querySelectorAll('.guide-item');
        var weatherIcon = document.getElementById('weatherIcon');
        var weatherTemp = document.getElementById('weatherTemp');
        var weatherDesc = document.getElementById('weatherDesc');
        var weatherPop = document.getElementById('weatherPop');
        var errorMessage = document.getElementById('errorMessage');
        var errorText = document.getElementById('errorText');
        var debugInfo = document.getElementById('debugInfo');

        var currentPoint = null;
        var userLat = null;
        var userLon = null;

        // LocalStorage keys
        var STORAGE_KEY_POINT = 'wbgt_last_point';

        // Save point to localStorage
        function saveLastPoint(point) {
            try {
                localStorage.setItem(STORAGE_KEY_POINT, JSON.stringify(point));
            } catch (e) {
                console.warn('Failed to save to localStorage:', e);
            }
        }

        // Load point from localStorage
        function loadLastPoint() {
            try {
                var saved = localStorage.getItem(STORAGE_KEY_POINT);
                return saved ? JSON.parse(saved) : null;
            } catch (e) {
                console.warn('Failed to load from localStorage:', e);
                return null;
            }
        }

        // „Éá„Éï„Ç©„É´„ÉàÂú∞ÁÇπÔºàÊù±‰∫¨Ôºâ
        var DEFAULT_POINT = { code: "44132", name: "Êù±‰∫¨", lat: 35.6895, lon: 139.6917 };

        // URL„Éë„É©„É°„Éº„Çø„ÇíÂèñÂæó
        function getURLParams() {
            var params = new URLSearchParams(window.location.search);
            return {
                location: params.get('location') || params.get('loc') || params.get('city'),
                lat: parseFloat(params.get('lat') || params.get('latitude')),
                lon: parseFloat(params.get('lon') || params.get('lng') || params.get('longitude'))
            };
        }

        // Âú∞ÁÇπÂêç„Åã„ÇâË¶≥Ê∏¨Âú∞ÁÇπ„ÇíÊ§úÁ¥¢
        function findPointByName(name) {
            var searchName = name.trim();
            var found = null;

            Object.keys(OBSERVATION_POINTS).forEach(function(region) {
                var prefs = OBSERVATION_POINTS[region];
                Object.keys(prefs).forEach(function(pref) {
                    var points = prefs[pref];
                    points.forEach(function(point) {
                        // ÂÆåÂÖ®‰∏ÄËá¥„Åæ„Åü„ÅØÈÉ®ÂàÜ‰∏ÄËá¥
                        if (point.name === searchName ||
                            point.name.includes(searchName) ||
                            searchName.includes(point.name)) {
                            found = point;
                        }
                    });
                });
            });

            return found;
        }

        // Yodeck„Éó„É¨„Éº„É§„Éº„Åã„Çâ‰ΩçÁΩÆÊÉÖÂ†±„ÇíÂèñÂæó
        async function getYodeckLocation() {
            console.log('=== Yodeck Location Check Start ===');
            console.log('window.yodeck exists:', typeof window.yodeck !== 'undefined');
            if (typeof window.yodeck !== 'undefined') {
                console.log('window.yodeck keys:', Object.keys(window.yodeck));
            }

            // Yodeck HTTP APIÁµåÁî±„Åß‰ΩçÁΩÆÊÉÖÂ†±„ÇíÂèñÂæó
            // Yodeck„Éó„É¨„Éº„É§„ÉºÂÜÖ„Åß„ÅÆ„ÅøÂãï‰ΩúÔºàlocalhost:8080Ôºâ
            try {
                // „Åæ„Åöinit_widget„Åã„Çâ„Éà„Éº„ÇØ„É≥„ÇíÂèñÂæó„ÇíË©¶„Åø„Çã
                var token = null;
                if (typeof window.yodeck !== 'undefined' && window.yodeck.init_widget) {
                    token = window.yodeck.init_widget.token;
                    console.log('Yodeck token found:', token ? 'yes' : 'no');
                }

                // Yodeck HTTP API„Å´„Ç¢„ÇØ„Çª„Çπ
                var headers = {};
                if (token) {
                    headers['Authorization'] = 'widget ' + token;
                }

                console.log('Fetching from localhost:8080/device...');
                var response = await fetch('http://localhost:8080/device', {
                    method: 'GET',
                    headers: headers
                });

                console.log('HTTP API response status:', response.status);
                if (response.ok) {
                    var data = await response.json();
                    console.log('Yodeck device info:', JSON.stringify(data));
                    // location„ÅØ [lat, lon] „ÅÆÈÖçÂàóÂΩ¢Âºè
                    if (data && data.location && Array.isArray(data.location) && data.location.length >= 2) {
                        console.log('Location found:', data.location);
                        return { lat: data.location[0], lon: data.location[1] };
                    } else {
                        console.log('Location not in response or invalid format');
                    }
                }
            } catch (e) {
                console.log('Yodeck HTTP API error:', e.message);
            }

            // ÊóßAPIÊñπÂºè„ÇÇË©¶„ÅôÔºà‰∫íÊèõÊÄß„ÅÆ„Åü„ÇÅÔºâ
            console.log('Trying legacy API...');
            return new Promise(function(resolve) {
                if (typeof window.yodeck !== 'undefined' && window.yodeck.getPlayerInfo) {
                    console.log('getPlayerInfo exists, calling...');
                    window.yodeck.getPlayerInfo(function(info) {
                        console.log('getPlayerInfo result:', JSON.stringify(info));
                        if (info && info.location && info.location.lat && info.location.lng) {
                            console.log('Legacy location found:', info.location);
                            resolve({ lat: info.location.lat, lon: info.location.lng });
                        } else {
                            console.log('Legacy location not available');
                            resolve(null);
                        }
                    });
                    setTimeout(function() {
                        console.log('Legacy API timeout');
                        resolve(null);
                    }, 2000);
                } else {
                    console.log('getPlayerInfo not available');
                    resolve(null);
                }
            });
        }

        // ÈÄÜ„Ç∏„Ç™„Ç≥„Éº„Éá„Ç£„É≥„Ç∞„ÅßÂú∞Âêç„ÇíÂèñÂæó
        async function getLocationName(lat, lon) {
            try {
                // Open-Meteo Geocoding API„ÅßÈÄÜ„Ç∏„Ç™„Ç≥„Éº„Éá„Ç£„É≥„Ç∞
                var url = 'https://geocoding-api.open-meteo.com/v1/search?name=' +
                    lat.toFixed(2) + ',' + lon.toFixed(2) +
                    '&count=1&language=ja&format=json';

                // ‰ª£„Çè„Çä„Å´Nominatim API„Çí‰ΩøÁî®ÔºàÁÑ°Êñô„ÄÅCORSÂØæÂøúÔºâ
                var nominatimUrl = 'https://nominatim.openstreetmap.org/reverse?' +
                    'lat=' + lat + '&lon=' + lon +
                    '&format=json&accept-language=ja';

                var response = await fetch(nominatimUrl, {
                    headers: { 'User-Agent': 'WeatherWBGTMonitor/1.0' }
                });

                if (response.ok) {
                    var data = await response.json();
                    if (data && data.address) {
                        // Â∏ÇÂå∫Áî∫ÊùëÂêç„ÇíÂèñÂæó
                        var city = data.address.city ||
                                   data.address.town ||
                                   data.address.village ||
                                   data.address.county ||
                                   data.address.state;
                        if (city) {
                            return city;
                        }
                    }
                }
            } catch (e) {
                console.warn('Reverse geocoding failed:', e);
            }
            return null;
        }

        // ‰ΩçÁΩÆÊÉÖÂ†±„Çí‰Ωø„Å£„Å¶ÂàùÊúüÂåñ
        async function initWithLocation(lat, lon, source) {
            console.log('Using location from ' + source + ':', lat, lon);
            userLat = lat;
            userLon = lon;

            var nearest = findNearestPoint(lat, lon);
            if (nearest && nearest.distance < 50) {
                // 50km‰ª•ÂÜÖ„Å´Ë¶≥Ê∏¨Âú∞ÁÇπ„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØ„Åù„Çå„Çí‰ΩøÁî®
                currentPoint = nearest.point;
                console.log('Nearest point:', currentPoint.name, 'Distance:', nearest.distance.toFixed(1) + 'km');
            } else {
                // ÈÄÜ„Ç∏„Ç™„Ç≥„Éº„Éá„Ç£„É≥„Ç∞„ÅßÂú∞Âêç„ÇíÂèñÂæó
                var locationName = await getLocationName(lat, lon);
                currentPoint = {
                    code: "custom",
                    name: locationName || (nearest ? nearest.point.name + '‰ªòËøë' : 'ÁèæÂú®Âú∞'),
                    lat: lat,
                    lon: lon
                };
                console.log('Using custom location:', currentPoint.name);
            }

            // ‰ΩçÁΩÆ„ÇíÂç≥Â∫ß„Å´Ë°®Á§∫
            if (locationEl) locationEl.textContent = currentPoint.name;

            // „Éá„Éº„ÇøÂèñÂæó
            fetchWBGTData();
            fetchJMAWeather();
        }

        // Yodeck API„ÅÆÊ∫ñÂÇô„ÇíÂæÖ„Å§
        function waitForYodeck(maxWait) {
            return new Promise(function(resolve) {
                var waited = 0;
                var interval = 100;

                function check() {
                    // crossbarÊé•Á∂ö„ÅåÁ¢∫Á´ã„Åï„Çå„Å¶„ÅÑ„Çã„Åã„ÉÅ„Çß„ÉÉ„ÇØ
                    if (typeof window.yodeck !== 'undefined') {
                        console.log('Yodeck object found after ' + waited + 'ms');
                        resolve(true);
                        return;
                    }

                    waited += interval;
                    if (waited >= maxWait) {
                        console.log('Yodeck not found after ' + maxWait + 'ms');
                        resolve(false);
                        return;
                    }

                    setTimeout(check, interval);
                }

                check();
            });
        }

        // Initialize
        (async function init() {
            console.log('=== Weather WBGT Monitor Init ===');

            var urlParams = getURLParams();

            // 1. URL„ÅÆÁ∑ØÂ∫¶ÁµåÂ∫¶„Éë„É©„É°„Éº„Çø„Çí„ÉÅ„Çß„ÉÉ„ÇØÔºàÊúÄÂÑ™ÂÖàÔºâ
            if (!isNaN(urlParams.lat) && !isNaN(urlParams.lon)) {
                console.log('Using URL lat/lon params');
                loadingOverlay.classList.add('hidden');
                initWithLocation(urlParams.lat, urlParams.lon, 'URL params');
            }
            // 2. URLÂú∞Âêç„Éë„É©„É°„Éº„Çø„Çí„ÉÅ„Çß„ÉÉ„ÇØ
            else if (urlParams.location) {
                console.log('Using URL location param:', urlParams.location);
                loadingOverlay.classList.add('hidden');
                var point = findPointByName(urlParams.location);
                if (point) {
                    console.log('Using URL location:', point.name);
                    currentPoint = point;
                } else {
                    console.log('URL location not found, using as custom name:', urlParams.location);
                    currentPoint = {
                        code: "custom",
                        name: urlParams.location,
                        lat: DEFAULT_POINT.lat,
                        lon: DEFAULT_POINT.lon
                    };
                }
                if (locationEl) locationEl.textContent = currentPoint.name;
                fetchWBGTData();
                fetchJMAWeather();
            }
            // 3. Yodeck„Éó„É¨„Éº„É§„Éº‰ΩçÁΩÆÊÉÖÂ†±„Çí„ÉÅ„Çß„ÉÉ„ÇØÔºàÂ∞ë„ÅóÂæÖ„Å§Ôºâ
            else {
                console.log('No URL params, checking for Yodeck...');

                // YodeckÁí∞Â¢É„ÅÆÂ†¥Âêà„ÄÅAPI„ÅÆÊ∫ñÂÇô„ÇíÂæÖ„Å§ÔºàÊúÄÂ§ß3ÁßíÔºâ
                await waitForYodeck(3000);

                loadingOverlay.classList.add('hidden');

                var yodeckLoc = await getYodeckLocation();
                if (yodeckLoc) {
                    console.log('Yodeck location obtained:', yodeckLoc);
                    initWithLocation(yodeckLoc.lat, yodeckLoc.lon, 'Yodeck player');
                }
                // 4. localStorage„Çí„ÉÅ„Çß„ÉÉ„ÇØ
                else {
                    var lastPoint = loadLastPoint();
                    if (lastPoint) {
                        console.log('Loaded from localStorage:', lastPoint.name);
                        currentPoint = lastPoint;
                    } else {
                        // 5. „Éá„Éï„Ç©„É´„ÉàÔºàÊù±‰∫¨Ôºâ„Çí‰ΩøÁî®
                        console.log('Using default:', DEFAULT_POINT.name);
                        currentPoint = DEFAULT_POINT;
                    }
                    if (locationEl) locationEl.textContent = currentPoint.name;
                    fetchWBGTData();
                    fetchJMAWeather();
                }
            }

            setInterval(function() {
                if (currentPoint) {
                    fetchWBGTData();
                    fetchJMAWeather();
                }
            }, 5 * 60 * 1000);
        })();

        // Show error
        function showError(message, debug) {
            errorText.textContent = message;
            debugInfo.textContent = debug || '';
            errorMessage.classList.add('show');
        }

        // Hide error
        function hideError() {
            errorMessage.classList.remove('show');
        }

        // Calculate distance
        function calculateDistance(lat1, lon1, lat2, lon2) {
            var R = 6371;
            var dLat = (lat2 - lat1) * Math.PI / 180;
            var dLon = (lon2 - lon1) * Math.PI / 180;
            var a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                    Math.sin(dLon/2) * Math.sin(dLon/2);
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }

        // Find nearest point
        function findNearestPoint(lat, lon) {
            var nearest = null;
            var minDistance = Infinity;

            Object.keys(OBSERVATION_POINTS).forEach(function(region) {
                var prefs = OBSERVATION_POINTS[region];
                Object.keys(prefs).forEach(function(pref) {
                    var points = prefs[pref];
                    points.forEach(function(point) {
                        var distance = calculateDistance(lat, lon, point.lat, point.lon);
                        if (distance < minDistance) {
                            minDistance = distance;
                            nearest = { region: region, pref: pref, point: point, distance: distance };
                        }
                    });
                });
            });

            return nearest;
        }

        // Get status info
        function getStatusInfo(wbgt) {
            if (wbgt >= 31) {
                return { level: 'danger', main: 'Âç±Èô∫', sub: 'ÈÅãÂãï„ÅØÂéüÂâá‰∏≠Ê≠¢', color: '#dc2626' };
            } else if (wbgt >= 28) {
                return { level: 'warning', main: 'Âé≥ÈáçË≠¶Êàí', sub: 'ÊøÄ„Åó„ÅÑÈÅãÂãï„ÅØ‰∏≠Ê≠¢', color: '#ea580c' };
            } else if (wbgt >= 25) {
                return { level: 'caution', main: 'Ë≠¶Êàí', sub: 'Á©çÊ•µÁöÑ„Å´‰ºëÊÜ©', color: '#ca8a04' };
            } else if (wbgt >= 21) {
                return { level: 'attention', main: 'Ê≥®ÊÑè', sub: 'Á©çÊ•µÁöÑ„Å´Ê∞¥ÂàÜË£úÁµ¶', color: '#16a34a' };
            } else {
                return { level: 'safe', main: '„Åª„ÅºÂÆâÂÖ®', sub: 'ÈÅ©ÂÆúÊ∞¥ÂàÜË£úÁµ¶', color: '#2563eb' };
            }
        }

        // Update UI
        function updateUI(wbgt, locationName) {
            var info = getStatusInfo(wbgt);

            wbgtValue.textContent = wbgt.toFixed(1);
            wbgtValue.style.color = info.color;

            locationEl.textContent = locationName;

            statusEl.className = 'status ' + info.level;
            statusMain.textContent = info.main;
            statusSub.textContent = info.sub;

            var now = new Date();
            lastUpdate.textContent = now.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });

            statusDot.style.background = info.color;

            guideItems.forEach(function(item) {
                if (item.dataset.level === info.level) {
                    item.classList.add('active');
                } else {
                    item.classList.remove('active');
                }
            });
        }

        // Fetch Weather using Open-Meteo API (CORSÂØæÂøú„ÄÅË®±ÂèØ‰∏çË¶Å)
        async function fetchJMAWeather() {
            if (!currentPoint) return;

            try {
                // Open-Meteo API - ÁÑ°Êñô„ÄÅCORSÂØæÂøú„ÄÅAPI„Ç≠„Éº‰∏çË¶Å
                var lat = currentPoint.lat;
                var lon = currentPoint.lon;
                var url = 'https://api.open-meteo.com/v1/forecast?' +
                    'latitude=' + lat +
                    '&longitude=' + lon +
                    '&current=temperature_2m,weather_code,precipitation_probability' +
                    '&timezone=Asia/Tokyo';

                var response = await fetch(url);
                if (!response.ok) throw new Error('Open-Meteo API error');

                var data = await response.json();
                parseOpenMeteoWeather(data);
            } catch (error) {
                console.error('Weather API error:', error);
                setDemoWeather();
            }
        }

        // Parse Open-Meteo Weather data
        function parseOpenMeteoWeather(data) {
            try {
                var current = data.current;
                var temp = Math.round(current.temperature_2m);
                var weatherCode = current.weather_code;
                var pop = current.precipitation_probability;

                // WMO„Ç≥„Éº„Éâ„Åã„Çâ„Ç¢„Ç§„Ç≥„É≥„Å®Ë™¨Êòé„ÇíÂèñÂæó
                var weather = WMO_WEATHER[weatherCode] || { icon: 'üå°Ô∏è', desc: '‰∏çÊòé' };

                weatherIcon.textContent = weather.icon;
                weatherDesc.textContent = weather.desc;
                weatherTemp.textContent = temp;
                weatherPop.textContent = (pop !== null && pop !== undefined) ? pop + '%' : '--%';

            } catch (error) {
                console.error('Parse weather error:', error);
                setDemoWeather();
            }
        }

        // Set demo weather
        function setDemoWeather() {
            weatherIcon.textContent = '‚òÄÔ∏è';
            weatherTemp.textContent = Math.round(3 + Math.random() * 5);
            weatherDesc.textContent = 'Êô¥„Çå';
            weatherPop.textContent = '10%';
        }

        // Check if WBGT season (April 20 - October 31)
        function isWBGTSeason() {
            var now = new Date();
            var month = now.getMonth() + 1; // 1-12
            var day = now.getDate();

            // 4Êúà20Êó•„Äú10Êúà31Êó•
            if (month >= 5 && month <= 9) return true;
            if (month === 4 && day >= 20) return true;
            if (month === 10) return true;
            return false;
        }

        // Fetch WBGT data
        async function fetchWBGTData() {
            if (!currentPoint) {
                hideWBGTSection('„Éá„Éº„Çø„ÇíÂèñÂæó„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü');
                return;
            }

            // ÂÜ¨Â≠£„ÅØWBGT„Éá„Éº„Çø„ÅåÈÖç‰ø°„Åï„Çå„Å™„ÅÑ
            if (!isWBGTSeason()) {
                hideWBGTSection('Êöë„ÅïÊåáÊï∞„ÅØ4Êúà‰∏ãÊó¨„Äú10Êúà„Å´ÈÖç‰ø°„Åï„Çå„Åæ„Åô');
                if (locationEl) locationEl.textContent = currentPoint.name;
                var now = new Date();
                if (lastUpdate) lastUpdate.textContent = now.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });
                return;
            }

            try {
                var response = await fetch(WBGT_API_BASE + '/get-wbgt-html', { method: 'GET', mode: 'cors' });
                if (!response.ok) throw new Error('API error');

                var html = await response.text();
                var wbgt = parseWBGTFromHTML(html);

                if (wbgt !== null) {
                    showWBGTSection();
                    updateUI(wbgt, currentPoint.name);
                } else {
                    throw new Error('Parse error');
                }
            } catch (error) {
                console.error('WBGT Fetch error:', error);
                hideWBGTSection('Êöë„ÅïÊåáÊï∞„ÇíÂèñÂæó„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü');
                if (locationEl) locationEl.textContent = currentPoint ? currentPoint.name : 'Êù±‰∫¨';
                var now = new Date();
                if (lastUpdate) lastUpdate.textContent = now.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });
            }
        }

        // Hide WBGT section
        function hideWBGTSection(message) {
            if (wbgtSection) wbgtSection.style.display = 'none';
            if (statusEl) statusEl.style.display = 'none';
            if (guideSection) {
                if (message) {
                    guideSection.innerHTML = '<div class="guide-title" style="color: var(--text-secondary);">' + message + '</div>';
                    guideSection.style.display = 'block';
                } else {
                    guideSection.style.display = 'none';
                }
            }
        }

        // Show WBGT section
        function showWBGTSection() {
            if (wbgtSection) wbgtSection.style.display = 'block';
            if (statusEl) statusEl.style.display = 'block';
            if (guideSection) guideSection.style.display = 'block';
        }

        // Parse WBGT from HTML
        function parseWBGTFromHTML(html) {
            var patterns = [
                /WBGT[Ôºö:]\s*([\d.]+)/i,
                /Êöë„ÅïÊåáÊï∞[Ôºö:]\s*([\d.]+)/,
                /([\d.]+)\s*‚ÑÉ/,
                /value[Ôºö:"]?\s*([\d.]+)/i
            ];

            for (var i = 0; i < patterns.length; i++) {
                var match = html.match(patterns[i]);
                if (match && match[1]) {
                    var value = parseFloat(match[1]);
                    if (!isNaN(value) && value >= 0 && value <= 50) {
                        return value;
                    }
                }
            }
            return null;
        }

        // Demo mode (weather only, no WBGT)
        function useDemoMode() {
            var message = isWBGTSeason() ? null : 'Êöë„ÅïÊåáÊï∞„ÅØ4Êúà‰∏ãÊó¨„Äú10Êúà„Å´ÈÖç‰ø°„Åï„Çå„Åæ„Åô';
            hideWBGTSection(message);
            if (locationEl) locationEl.textContent = currentPoint ? currentPoint.name : 'Êù±‰∫¨';
            var now = new Date();
            if (lastUpdate) lastUpdate.textContent = now.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });
            if (statusDot) statusDot.style.background = '#16a34a';
            setDemoWeather();
        }
    </script>
</body>
</html>
