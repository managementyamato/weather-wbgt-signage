<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤©æ°—ãƒ»æš‘ã•æŒ‡æ•°ãƒ¢ãƒ‹ã‚¿ãƒ¼</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #f5f7fa;
            --bg-card: #ffffff;
            --text-primary: #1a1a2e;
            --text-secondary: #64748b;
            --border-color: #e2e8f0;
            --danger: #dc2626;
            --warning: #ea580c;
            --caution: #ca8a04;
            --attention: #16a34a;
            --safe: #2563eb;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            height: 100%;
            overflow: hidden;
        }

        body {
            font-family: 'Noto Sans JP', sans-serif;
            background: var(--bg-card);
            color: var(--text-primary);
        }

        .container {
            width: 100%;
            height: 100%;
        }

        .card {
            background: var(--bg-card);
            height: 100%;
            display: flex;
            flex-direction: column;
            padding: 3vh 4vw;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 2vh;
            border-bottom: 2px solid var(--border-color);
            flex-shrink: 0;
        }

        .title {
            font-size: clamp(1.2rem, 3vw, 2rem);
            font-weight: 700;
            color: var(--text-primary);
        }

        .location {
            font-size: clamp(1rem, 2.5vw, 1.8rem);
            color: var(--text-secondary);
            background: var(--bg-primary);
            padding: 1vh 2vw;
            border-radius: 8px;
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: row;
            gap: 4vw;
            padding: 2vh 0;
            min-height: 0;
        }

        .weather-section {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 3vw;
            border-right: 2px solid var(--border-color);
            padding-right: 4vw;
        }

        .weather-icon {
            font-size: clamp(4rem, 12vw, 10rem);
        }

        .weather-info {
            text-align: left;
        }

        .weather-temp {
            font-size: clamp(3rem, 10vw, 8rem);
            font-weight: 900;
            line-height: 1;
        }

        .weather-desc {
            font-size: clamp(1rem, 3vw, 2.5rem);
            color: var(--text-secondary);
            margin-top: 1vh;
        }

        .weather-details {
            display: flex;
            gap: 2vw;
            margin-top: 1.5vh;
            font-size: clamp(0.9rem, 2vw, 1.8rem);
            color: var(--text-secondary);
        }

        .weather-detail {
            display: flex;
            align-items: center;
            gap: 0.5vw;
        }

        .wbgt-section-wrapper {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .value-section {
            text-align: center;
        }

        .value-label {
            font-size: clamp(1rem, 2vw, 1.8rem);
            color: var(--text-secondary);
            margin-bottom: 1vh;
            letter-spacing: 0.5px;
        }

        .value-container {
            display: flex;
            align-items: baseline;
            justify-content: center;
            gap: 0.5vw;
        }

        .value {
            font-size: clamp(4rem, 12vw, 10rem);
            font-weight: 900;
            line-height: 1;
            transition: color 0.3s ease;
        }

        .unit {
            font-size: clamp(1.5rem, 4vw, 3rem);
            font-weight: 500;
            color: var(--text-secondary);
        }

        .status {
            text-align: center;
            padding: 2vh 2vw;
            border-radius: 12px;
            margin-top: 2vh;
            font-weight: 700;
            transition: all 0.3s ease;
        }

        .status.danger {
            background: rgba(220, 38, 38, 0.15);
            color: var(--danger);
            border: 3px solid var(--danger);
        }

        .status.warning {
            background: rgba(234, 88, 12, 0.15);
            color: var(--warning);
            border: 3px solid var(--warning);
        }

        .status.caution {
            background: rgba(202, 138, 4, 0.15);
            color: var(--caution);
            border: 3px solid var(--caution);
        }

        .status.attention {
            background: rgba(22, 163, 74, 0.15);
            color: var(--attention);
            border: 3px solid var(--attention);
        }

        .status.safe {
            background: rgba(37, 99, 235, 0.15);
            color: var(--safe);
            border: 3px solid var(--safe);
        }

        .status-main {
            font-size: clamp(1.5rem, 4vw, 3rem);
            margin-bottom: 0.5vh;
        }

        .status-sub {
            font-size: clamp(1rem, 2.5vw, 2rem);
            font-weight: 500;
            opacity: 0.9;
        }

        .guide {
            padding-top: 2vh;
            border-top: 2px solid var(--border-color);
            flex-shrink: 0;
        }

        .guide-title {
            font-size: clamp(0.9rem, 1.5vw, 1.4rem);
            color: var(--text-secondary);
            margin-bottom: 1.5vh;
            text-align: center;
        }

        .guide-items {
            display: flex;
            justify-content: space-between;
            gap: 1vw;
        }

        .guide-item {
            flex: 1;
            text-align: center;
            padding: 1.5vh 1vw;
            border-radius: 8px;
            background: var(--bg-primary);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .guide-item.active {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .guide-level {
            font-size: clamp(0.8rem, 1.5vw, 1.3rem);
            font-weight: 700;
            margin-bottom: 0.5vh;
        }

        .guide-level.danger { color: var(--danger); }
        .guide-level.warning { color: var(--warning); }
        .guide-level.caution { color: var(--caution); }
        .guide-level.attention { color: var(--attention); }
        .guide-level.safe { color: var(--safe); }

        .guide-range {
            font-size: clamp(0.7rem, 1.2vw, 1.1rem);
            color: var(--text-secondary);
        }

        .footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 2vh;
            border-top: 2px solid var(--border-color);
            font-size: clamp(0.9rem, 1.5vw, 1.3rem);
            color: var(--text-secondary);
            flex-shrink: 0;
        }

        .update-time {
            display: flex;
            align-items: center;
            gap: 1vw;
        }

        .status-dot {
            width: clamp(10px, 1vw, 16px);
            height: clamp(10px, 1vw, 16px);
            border-radius: 50%;
            background: var(--attention);
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-primary);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 1;
            visibility: visible;
            transition: opacity 0.4s ease, visibility 0.4s ease;
        }

        .loading-overlay.hidden {
            opacity: 0;
            visibility: hidden;
        }

        .loading-spinner {
            width: 48px;
            height: 48px;
            border: 3px solid var(--border-color);
            border-top-color: var(--text-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 16px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .error-message {
            background: rgba(220, 38, 38, 0.1);
            border: 1px solid var(--danger);
            color: var(--danger);
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 16px;
            font-size: 0.85rem;
            display: none;
        }

        .error-message.show {
            display: block;
        }

        .debug-info {
            background: var(--bg-primary);
            padding: 12px;
            border-radius: 8px;
            margin-top: 8px;
            font-size: 0.75rem;
            color: var(--text-secondary);
            word-break: break-all;
        }

        /* ç¸¦å‘ãç”»é¢ - ä¸Šä¸‹ã«é…ç½® */
        @media (orientation: portrait) {
            .main-content {
                flex-direction: column;
                gap: 2vh;
            }
            .weather-section {
                border-right: none;
                border-bottom: 2px solid var(--border-color);
                padding-right: 0;
                padding-bottom: 2vh;
            }
            .wbgt-section-wrapper {
                flex: 1;
            }
        }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <div class="loading-text">ç¾åœ¨åœ°ã‚’å–å¾—ä¸­...</div>
    </div>

    <div class="container">
        <div class="card">
            <div class="error-message" id="errorMessage">
                <div id="errorText"></div>
                <div class="debug-info" id="debugInfo"></div>
            </div>

            <div class="header">
                <div class="title">å¤©æ°—ãƒ»æš‘ã•æŒ‡æ•°ãƒ¢ãƒ‹ã‚¿ãƒ¼</div>
                <div class="location" id="location">å–å¾—ä¸­...</div>
            </div>

            <div class="main-content">
                <div class="weather-section">
                    <div class="weather-icon" id="weatherIcon">--</div>
                    <div class="weather-info">
                        <div class="weather-temp"><span id="weatherTemp">--</span>â„ƒ</div>
                        <div class="weather-desc" id="weatherDesc">--</div>
                        <div class="weather-details">
                            <div class="weather-detail">
                                <span>é™æ°´ç¢ºç‡</span>
                                <span id="weatherPop">--%</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="wbgt-section-wrapper">
                    <div class="value-section" id="wbgtSection">
                        <div class="value-label">æš‘ã•æŒ‡æ•° (WBGT)</div>
                        <div class="value-container">
                            <span class="value" id="wbgtValue">--</span>
                            <span class="unit">â„ƒ</span>
                        </div>
                    </div>

                    <div class="status safe" id="status">
                        <div class="status-main" id="statusMain">--</div>
                        <div class="status-sub" id="statusSub">--</div>
                    </div>
                </div>
            </div>

            <div class="guide" id="guideSection">
                <div class="guide-title">æš‘ã•æŒ‡æ•°ãƒ¬ãƒ™ãƒ«</div>
                <div class="guide-items">
                    <div class="guide-item" data-level="danger">
                        <div class="guide-level danger">å±é™º</div>
                        <div class="guide-range">31â„ƒä»¥ä¸Š</div>
                    </div>
                    <div class="guide-item" data-level="warning">
                        <div class="guide-level warning">å³é‡è­¦æˆ’</div>
                        <div class="guide-range">28-31â„ƒ</div>
                    </div>
                    <div class="guide-item" data-level="caution">
                        <div class="guide-level caution">è­¦æˆ’</div>
                        <div class="guide-range">25-28â„ƒ</div>
                    </div>
                    <div class="guide-item" data-level="attention">
                        <div class="guide-level attention">æ³¨æ„</div>
                        <div class="guide-range">21-25â„ƒ</div>
                    </div>
                    <div class="guide-item" data-level="safe">
                        <div class="guide-level safe">ã»ã¼å®‰å…¨</div>
                        <div class="guide-range">21â„ƒæœªæº€</div>
                    </div>
                </div>
            </div>

            <div class="footer">
                <div class="update-time">
                    <div class="status-dot" id="statusDot"></div>
                    <span>æœ€çµ‚æ›´æ–°: <span id="lastUpdate">--:--</span></span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // API URLs
        var WBGT_API_BASE = 'https://wbgt-api-server-422283659205.asia-northeast1.run.app';

        // Open-Meteo WMO Weather Code mapping
        var WMO_WEATHER = {
            0: { icon: "â˜€ï¸", desc: "å¿«æ™´" },
            1: { icon: "ğŸŒ¤ï¸", desc: "æ™´ã‚Œ" },
            2: { icon: "â›…", desc: "ãã‚‚ã‚Š" },
            3: { icon: "â˜ï¸", desc: "ãã‚‚ã‚Š" },
            45: { icon: "ğŸŒ«ï¸", desc: "éœ§" },
            48: { icon: "ğŸŒ«ï¸", desc: "éœ§æ°·" },
            51: { icon: "ğŸŒ§ï¸", desc: "å°é›¨" },
            53: { icon: "ğŸŒ§ï¸", desc: "é›¨" },
            55: { icon: "ğŸŒ§ï¸", desc: "å¼·ã„é›¨" },
            56: { icon: "ğŸŒ§ï¸", desc: "å‡é›¨" },
            57: { icon: "ğŸŒ§ï¸", desc: "å‡é›¨" },
            61: { icon: "ğŸŒ§ï¸", desc: "å°é›¨" },
            63: { icon: "ğŸŒ§ï¸", desc: "é›¨" },
            65: { icon: "ğŸŒ§ï¸", desc: "å¼·ã„é›¨" },
            66: { icon: "ğŸŒ§ï¸", desc: "å‡é›¨" },
            67: { icon: "ğŸŒ§ï¸", desc: "å‡é›¨" },
            71: { icon: "ğŸŒ¨ï¸", desc: "å°é›ª" },
            73: { icon: "ğŸŒ¨ï¸", desc: "é›ª" },
            75: { icon: "ğŸŒ¨ï¸", desc: "å¤§é›ª" },
            77: { icon: "ğŸŒ¨ï¸", desc: "éœ§é›ª" },
            80: { icon: "ğŸŒ¦ï¸", desc: "ã«ã‚ã‹é›¨" },
            81: { icon: "ğŸŒ§ï¸", desc: "ã«ã‚ã‹é›¨" },
            82: { icon: "â›ˆï¸", desc: "æ¿€ã—ã„ã«ã‚ã‹é›¨" },
            85: { icon: "ğŸŒ¨ï¸", desc: "ã«ã‚ã‹é›ª" },
            86: { icon: "ğŸŒ¨ï¸", desc: "ã«ã‚ã‹é›ª" },
            95: { icon: "â›ˆï¸", desc: "é›·é›¨" },
            96: { icon: "â›ˆï¸", desc: "é›·é›¨ï¼ˆé›¹ï¼‰" },
            99: { icon: "â›ˆï¸", desc: "é›·é›¨ï¼ˆå¤§ç²’ã®é›¹ï¼‰" }
        };

        // è¦³æ¸¬åœ°ç‚¹ãƒ‡ãƒ¼ã‚¿
        var OBSERVATION_POINTS = {
            "åŒ—æµ·é“": {
                "å®—è°·": [{ code: "11016", name: "ç¨šå†…", lat: 45.4167, lon: 141.6833 }],
                "ä¸Šå·": [{ code: "12442", name: "æ—­å·", lat: 43.7667, lon: 142.3667 }],
                "çŸ³ç‹©": [{ code: "14163", name: "æœ­å¹Œ", lat: 43.0608, lon: 141.3544 }],
                "æ¸¡å³¶": [{ code: "15041", name: "å‡½é¤¨", lat: 41.8167, lon: 140.7500 }]
            },
            "æ±åŒ—": {
                "é’æ£®çœŒ": [{ code: "31312", name: "é’æ£®", lat: 40.8222, lon: 140.7472 }],
                "å²©æ‰‹çœŒ": [{ code: "33472", name: "ç››å²¡", lat: 39.7000, lon: 141.1667 }],
                "å®®åŸçœŒ": [{ code: "34392", name: "ä»™å°", lat: 38.2667, lon: 140.8667 }],
                "ç§‹ç”°çœŒ": [{ code: "32402", name: "ç§‹ç”°", lat: 39.7167, lon: 140.1000 }],
                "å±±å½¢çœŒ": [{ code: "35426", name: "å±±å½¢", lat: 38.2556, lon: 140.3389 }],
                "ç¦å³¶çœŒ": [{ code: "36126", name: "ç¦å³¶", lat: 37.7500, lon: 140.4667 }]
            },
            "é–¢æ±": {
                "èŒ¨åŸçœŒ": [{ code: "40201", name: "æ°´æˆ¸", lat: 36.3667, lon: 140.4667 }],
                "æ ƒæœ¨çœŒ": [{ code: "41277", name: "å®‡éƒ½å®®", lat: 36.5500, lon: 139.8667 }],
                "ç¾¤é¦¬çœŒ": [{ code: "42251", name: "å‰æ©‹", lat: 36.3833, lon: 139.0667 }],
                "åŸ¼ç‰çœŒ": [{ code: "43056", name: "ã•ã„ãŸã¾", lat: 35.8617, lon: 139.6453 }],
                "åƒè‘‰çœŒ": [{ code: "45147", name: "åƒè‘‰", lat: 35.6000, lon: 140.1000 }],
                "æ±äº¬éƒ½": [{ code: "44132", name: "æ±äº¬", lat: 35.6895, lon: 139.6917 }],
                "ç¥å¥ˆå·çœŒ": [{ code: "46106", name: "æ¨ªæµœ", lat: 35.4500, lon: 139.6500 }]
            },
            "åŒ—é™¸": {
                "æ–°æ½ŸçœŒ": [{ code: "54232", name: "æ–°æ½Ÿ", lat: 37.9167, lon: 139.0500 }],
                "å¯Œå±±çœŒ": [{ code: "55102", name: "å¯Œå±±", lat: 36.7000, lon: 137.2167 }],
                "çŸ³å·çœŒ": [{ code: "56227", name: "é‡‘æ²¢", lat: 36.5944, lon: 136.6256 }],
                "ç¦äº•çœŒ": [{ code: "57066", name: "ç¦äº•", lat: 36.0667, lon: 136.2167 }]
            },
            "ä¸­éƒ¨": {
                "å±±æ¢¨çœŒ": [{ code: "49142", name: "ç”²åºœ", lat: 35.6667, lon: 138.5500 }],
                "é•·é‡çœŒ": [{ code: "48331", name: "é•·é‡", lat: 36.6500, lon: 138.1833 }],
                "å²é˜œçœŒ": [{ code: "52586", name: "å²é˜œ", lat: 35.4167, lon: 136.7500 }],
                "é™å²¡çœŒ": [{ code: "50331", name: "é™å²¡", lat: 34.9833, lon: 138.3833 }],
                "æ„›çŸ¥çœŒ": [{ code: "51106", name: "åå¤å±‹", lat: 35.1667, lon: 136.9667 }]
            },
            "è¿‘ç•¿": {
                "ä¸‰é‡çœŒ": [{ code: "53133", name: "æ´¥", lat: 34.7333, lon: 136.5167 }],
                "æ»‹è³€çœŒ": [{ code: "60131", name: "å½¦æ ¹", lat: 35.2667, lon: 136.2500 }],
                "äº¬éƒ½åºœ": [{ code: "61286", name: "äº¬éƒ½", lat: 35.0167, lon: 135.7333 }],
                "å¤§é˜ªåºœ": [{ code: "62078", name: "å¤§é˜ª", lat: 34.6833, lon: 135.5167 }],
                "å…µåº«çœŒ": [{ code: "63518", name: "ç¥æˆ¸", lat: 34.6913, lon: 135.1830 }],
                "å¥ˆè‰¯çœŒ": [{ code: "64036", name: "å¥ˆè‰¯", lat: 34.6833, lon: 135.8333 }],
                "å’Œæ­Œå±±çœŒ": [{ code: "65042", name: "å’Œæ­Œå±±", lat: 34.2333, lon: 135.1667 }]
            },
            "ä¸­å›½": {
                "é³¥å–çœŒ": [{ code: "69122", name: "é³¥å–", lat: 35.5000, lon: 134.2333 }],
                "å³¶æ ¹çœŒ": [{ code: "68132", name: "æ¾æ±Ÿ", lat: 35.4667, lon: 133.0500 }],
                "å²¡å±±çœŒ": [{ code: "66408", name: "å²¡å±±", lat: 34.6500, lon: 133.9167 }],
                "åºƒå³¶çœŒ": [{ code: "67437", name: "åºƒå³¶", lat: 34.3833, lon: 132.4500 }],
                "å±±å£çœŒ": [{ code: "81428", name: "ä¸‹é–¢", lat: 33.9500, lon: 130.9333 }]
            },
            "å››å›½": {
                "å¾³å³¶çœŒ": [{ code: "71106", name: "å¾³å³¶", lat: 34.0667, lon: 134.5500 }],
                "é¦™å·çœŒ": [{ code: "72086", name: "é«˜æ¾", lat: 34.3167, lon: 134.0500 }],
                "æ„›åª›çœŒ": [{ code: "73166", name: "æ¾å±±", lat: 33.8333, lon: 132.7833 }],
                "é«˜çŸ¥çœŒ": [{ code: "74181", name: "é«˜çŸ¥", lat: 33.5500, lon: 133.5333 }]
            },
            "ä¹å·": {
                "ç¦å²¡çœŒ": [{ code: "82182", name: "ç¦å²¡", lat: 33.5833, lon: 130.3833 }],
                "ä½è³€çœŒ": [{ code: "85142", name: "ä½è³€", lat: 33.2500, lon: 130.3000 }],
                "é•·å´çœŒ": [{ code: "84496", name: "é•·å´", lat: 32.7333, lon: 129.8667 }],
                "ç†Šæœ¬çœŒ": [{ code: "86141", name: "ç†Šæœ¬", lat: 32.8000, lon: 130.7000 }],
                "å¤§åˆ†çœŒ": [{ code: "83216", name: "å¤§åˆ†", lat: 33.2333, lon: 131.6167 }],
                "å®®å´çœŒ": [{ code: "87376", name: "å®®å´", lat: 31.9333, lon: 131.4167 }],
                "é¹¿å…å³¶çœŒ": [{ code: "88317", name: "é¹¿å…å³¶", lat: 31.5667, lon: 130.5500 }]
            },
            "æ²–ç¸„": {
                "æ²–ç¸„çœŒ": [{ code: "91197", name: "é‚£è¦‡", lat: 26.2167, lon: 127.6833 }]
            }
        };

        // DOM Elements - script is at end of body so DOM is ready
        var loadingOverlay = document.getElementById('loadingOverlay');
        var wbgtValue = document.getElementById('wbgtValue');
        var wbgtSection = document.getElementById('wbgtSection');
        var guideSection = document.getElementById('guideSection');
        var locationEl = document.getElementById('location');
        var statusEl = document.getElementById('status');
        var statusMain = document.getElementById('statusMain');
        var statusSub = document.getElementById('statusSub');
        var lastUpdate = document.getElementById('lastUpdate');
        var statusDot = document.getElementById('statusDot');
        var guideItems = document.querySelectorAll('.guide-item');
        var weatherIcon = document.getElementById('weatherIcon');
        var weatherTemp = document.getElementById('weatherTemp');
        var weatherDesc = document.getElementById('weatherDesc');
        var weatherPop = document.getElementById('weatherPop');
        var errorMessage = document.getElementById('errorMessage');
        var errorText = document.getElementById('errorText');
        var debugInfo = document.getElementById('debugInfo');

        var currentPoint = null;
        var userLat = null;
        var userLon = null;

        // LocalStorage keys
        var STORAGE_KEY_POINT = 'wbgt_last_point';

        // Save point to localStorage
        function saveLastPoint(point) {
            try {
                localStorage.setItem(STORAGE_KEY_POINT, JSON.stringify(point));
            } catch (e) {
                console.warn('Failed to save to localStorage:', e);
            }
        }

        // Load point from localStorage
        function loadLastPoint() {
            try {
                var saved = localStorage.getItem(STORAGE_KEY_POINT);
                return saved ? JSON.parse(saved) : null;
            } catch (e) {
                console.warn('Failed to load from localStorage:', e);
                return null;
            }
        }

        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆåœ°ç‚¹ï¼ˆæ±äº¬ï¼‰
        var DEFAULT_POINT = { code: "44132", name: "æ±äº¬", lat: 35.6895, lon: 139.6917 };

        // Initialize immediately since script is at end of body
        (function init() {
            // Try to load last point from localStorage, or use default
            var lastPoint = loadLastPoint();
            if (lastPoint) {
                console.log('Loaded from localStorage:', lastPoint.name);
                currentPoint = lastPoint;
            } else {
                // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆåœ°ç‚¹ã‚’ä½¿ç”¨ï¼ˆè¨±å¯ãªã—ã§ã‚‚ã™ãã«è¡¨ç¤ºï¼‰
                console.log('Using default point:', DEFAULT_POINT.name);
                currentPoint = DEFAULT_POINT;
            }

            // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’ã™ãã«éè¡¨ç¤ºã«ã—ã¦ãƒ‡ãƒ¼ã‚¿å–å¾—é–‹å§‹
            loadingOverlay.classList.add('hidden');
            fetchWBGTData();
            fetchJMAWeather();

            // GPSã¯å®Œå…¨ã«ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§ï¼ˆè¨±å¯ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’å‡ºã•ãªã„å ´åˆã‚‚ã‚ã‚‹ï¼‰
            tryGetGPSLocationSilently();

            setInterval(function() {
                if (currentPoint) {
                    fetchWBGTData();
                    fetchJMAWeather();
                }
            }, 5 * 60 * 1000);
        })();

        // GPSä½ç½®æƒ…å ±ã‚’é™ã‹ã«å–å¾—ï¼ˆã‚¨ãƒ©ãƒ¼ã¯ç„¡è¦–ï¼‰
        function tryGetGPSLocationSilently() {
            if (!navigator.geolocation || !isSecureContext()) {
                return; // å¯¾å¿œã—ã¦ã„ãªã‘ã‚Œã°ä½•ã‚‚ã—ãªã„
            }

            navigator.geolocation.getCurrentPosition(
                function(position) {
                    console.log('GPS success:', position.coords.latitude, position.coords.longitude);
                    userLat = position.coords.latitude;
                    userLon = position.coords.longitude;
                    var nearest = findNearestPoint(userLat, userLon);
                    if (nearest && nearest.point.name !== currentPoint.name) {
                        currentPoint = nearest.point;
                        saveLastPoint(currentPoint);
                        console.log('Updated to nearest point:', currentPoint.name);
                        fetchWBGTData();
                        fetchJMAWeather();
                    }
                },
                function(error) {
                    // ã‚¨ãƒ©ãƒ¼ã¯é™ã‹ã«ç„¡è¦–ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆåœ°ç‚¹ã‚’ä½¿ã„ç¶šã‘ã‚‹ï¼‰
                    console.log('GPS not available, using default:', currentPoint.name);
                },
                {
                    enableHighAccuracy: false, // ç²¾åº¦ã‚ˆã‚Šé€Ÿåº¦å„ªå…ˆ
                    timeout: 5000,
                    maximumAge: 600000 // 10åˆ†é–“ã‚­ãƒ£ãƒƒã‚·ãƒ¥OK
                }
            );
        }

        // Show error
        function showError(message, debug) {
            errorText.textContent = message;
            debugInfo.textContent = debug || '';
            errorMessage.classList.add('show');
        }

        // Hide error
        function hideError() {
            errorMessage.classList.remove('show');
        }

        // Check if secure context
        function isSecureContext() {
            return window.isSecureContext ||
                   location.protocol === 'https:' ||
                   location.hostname === 'localhost' ||
                   location.hostname === '127.0.0.1';
        }

        // Calculate distance
        function calculateDistance(lat1, lon1, lat2, lon2) {
            var R = 6371;
            var dLat = (lat2 - lat1) * Math.PI / 180;
            var dLon = (lon2 - lon1) * Math.PI / 180;
            var a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                    Math.sin(dLon/2) * Math.sin(dLon/2);
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }

        // Find nearest point
        function findNearestPoint(lat, lon) {
            var nearest = null;
            var minDistance = Infinity;

            Object.keys(OBSERVATION_POINTS).forEach(function(region) {
                var prefs = OBSERVATION_POINTS[region];
                Object.keys(prefs).forEach(function(pref) {
                    var points = prefs[pref];
                    points.forEach(function(point) {
                        var distance = calculateDistance(lat, lon, point.lat, point.lon);
                        if (distance < minDistance) {
                            minDistance = distance;
                            nearest = { region: region, pref: pref, point: point, distance: distance };
                        }
                    });
                });
            });

            return nearest;
        }

        // Get status info
        function getStatusInfo(wbgt) {
            if (wbgt >= 31) {
                return { level: 'danger', main: 'å±é™º', sub: 'é‹å‹•ã¯åŸå‰‡ä¸­æ­¢', color: '#dc2626' };
            } else if (wbgt >= 28) {
                return { level: 'warning', main: 'å³é‡è­¦æˆ’', sub: 'æ¿€ã—ã„é‹å‹•ã¯ä¸­æ­¢', color: '#ea580c' };
            } else if (wbgt >= 25) {
                return { level: 'caution', main: 'è­¦æˆ’', sub: 'ç©æ¥µçš„ã«ä¼‘æ†©', color: '#ca8a04' };
            } else if (wbgt >= 21) {
                return { level: 'attention', main: 'æ³¨æ„', sub: 'ç©æ¥µçš„ã«æ°´åˆ†è£œçµ¦', color: '#16a34a' };
            } else {
                return { level: 'safe', main: 'ã»ã¼å®‰å…¨', sub: 'é©å®œæ°´åˆ†è£œçµ¦', color: '#2563eb' };
            }
        }

        // Update UI
        function updateUI(wbgt, locationName) {
            var info = getStatusInfo(wbgt);

            wbgtValue.textContent = wbgt.toFixed(1);
            wbgtValue.style.color = info.color;

            locationEl.textContent = locationName;

            statusEl.className = 'status ' + info.level;
            statusMain.textContent = info.main;
            statusSub.textContent = info.sub;

            var now = new Date();
            lastUpdate.textContent = now.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });

            statusDot.style.background = info.color;

            guideItems.forEach(function(item) {
                if (item.dataset.level === info.level) {
                    item.classList.add('active');
                } else {
                    item.classList.remove('active');
                }
            });
        }

        // Fetch Weather using Open-Meteo API (CORSå¯¾å¿œã€è¨±å¯ä¸è¦)
        async function fetchJMAWeather() {
            if (!currentPoint) return;

            try {
                // Open-Meteo API - ç„¡æ–™ã€CORSå¯¾å¿œã€APIã‚­ãƒ¼ä¸è¦
                var lat = currentPoint.lat;
                var lon = currentPoint.lon;
                var url = 'https://api.open-meteo.com/v1/forecast?' +
                    'latitude=' + lat +
                    '&longitude=' + lon +
                    '&current=temperature_2m,weather_code,precipitation_probability' +
                    '&timezone=Asia/Tokyo';

                var response = await fetch(url);
                if (!response.ok) throw new Error('Open-Meteo API error');

                var data = await response.json();
                parseOpenMeteoWeather(data);
            } catch (error) {
                console.error('Weather API error:', error);
                setDemoWeather();
            }
        }

        // Parse Open-Meteo Weather data
        function parseOpenMeteoWeather(data) {
            try {
                var current = data.current;
                var temp = Math.round(current.temperature_2m);
                var weatherCode = current.weather_code;
                var pop = current.precipitation_probability;

                // WMOã‚³ãƒ¼ãƒ‰ã‹ã‚‰ã‚¢ã‚¤ã‚³ãƒ³ã¨èª¬æ˜ã‚’å–å¾—
                var weather = WMO_WEATHER[weatherCode] || { icon: 'ğŸŒ¡ï¸', desc: 'ä¸æ˜' };

                weatherIcon.textContent = weather.icon;
                weatherDesc.textContent = weather.desc;
                weatherTemp.textContent = temp;
                weatherPop.textContent = (pop !== null && pop !== undefined) ? pop + '%' : '--%';

            } catch (error) {
                console.error('Parse weather error:', error);
                setDemoWeather();
            }
        }

        // Set demo weather
        function setDemoWeather() {
            weatherIcon.textContent = 'â˜€ï¸';
            weatherTemp.textContent = Math.round(3 + Math.random() * 5);
            weatherDesc.textContent = 'æ™´ã‚Œ';
            weatherPop.textContent = '10%';
        }

        // Check if WBGT season (April 20 - October 31)
        function isWBGTSeason() {
            var now = new Date();
            var month = now.getMonth() + 1; // 1-12
            var day = now.getDate();

            // 4æœˆ20æ—¥ã€œ10æœˆ31æ—¥
            if (month >= 5 && month <= 9) return true;
            if (month === 4 && day >= 20) return true;
            if (month === 10) return true;
            return false;
        }

        // Fetch WBGT data
        async function fetchWBGTData() {
            if (!currentPoint) {
                hideWBGTSection('ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ');
                return;
            }

            // å†¬å­£ã¯WBGTãƒ‡ãƒ¼ã‚¿ãŒé…ä¿¡ã•ã‚Œãªã„
            if (!isWBGTSeason()) {
                hideWBGTSection('æš‘ã•æŒ‡æ•°ã¯4æœˆä¸‹æ—¬ã€œ10æœˆã«é…ä¿¡ã•ã‚Œã¾ã™');
                if (locationEl) locationEl.textContent = currentPoint.name;
                var now = new Date();
                if (lastUpdate) lastUpdate.textContent = now.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });
                return;
            }

            try {
                var response = await fetch(WBGT_API_BASE + '/get-wbgt-html', { method: 'GET', mode: 'cors' });
                if (!response.ok) throw new Error('API error');

                var html = await response.text();
                var wbgt = parseWBGTFromHTML(html);

                if (wbgt !== null) {
                    showWBGTSection();
                    updateUI(wbgt, currentPoint.name);
                } else {
                    throw new Error('Parse error');
                }
            } catch (error) {
                console.error('WBGT Fetch error:', error);
                hideWBGTSection('æš‘ã•æŒ‡æ•°ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ');
                if (locationEl) locationEl.textContent = currentPoint ? currentPoint.name : 'æ±äº¬';
                var now = new Date();
                if (lastUpdate) lastUpdate.textContent = now.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });
            }
        }

        // Hide WBGT section
        function hideWBGTSection(message) {
            if (wbgtSection) wbgtSection.style.display = 'none';
            if (statusEl) statusEl.style.display = 'none';
            if (guideSection) {
                if (message) {
                    guideSection.innerHTML = '<div class="guide-title" style="color: var(--text-secondary);">' + message + '</div>';
                    guideSection.style.display = 'block';
                } else {
                    guideSection.style.display = 'none';
                }
            }
        }

        // Show WBGT section
        function showWBGTSection() {
            if (wbgtSection) wbgtSection.style.display = 'block';
            if (statusEl) statusEl.style.display = 'block';
            if (guideSection) guideSection.style.display = 'block';
        }

        // Parse WBGT from HTML
        function parseWBGTFromHTML(html) {
            var patterns = [
                /WBGT[ï¼š:]\s*([\d.]+)/i,
                /æš‘ã•æŒ‡æ•°[ï¼š:]\s*([\d.]+)/,
                /([\d.]+)\s*â„ƒ/,
                /value[ï¼š:"]?\s*([\d.]+)/i
            ];

            for (var i = 0; i < patterns.length; i++) {
                var match = html.match(patterns[i]);
                if (match && match[1]) {
                    var value = parseFloat(match[1]);
                    if (!isNaN(value) && value >= 0 && value <= 50) {
                        return value;
                    }
                }
            }
            return null;
        }

        // Demo mode (weather only, no WBGT)
        function useDemoMode() {
            var message = isWBGTSeason() ? null : 'æš‘ã•æŒ‡æ•°ã¯4æœˆä¸‹æ—¬ã€œ10æœˆã«é…ä¿¡ã•ã‚Œã¾ã™';
            hideWBGTSection(message);
            if (locationEl) locationEl.textContent = currentPoint ? currentPoint.name : 'æ±äº¬';
            var now = new Date();
            if (lastUpdate) lastUpdate.textContent = now.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });
            if (statusDot) statusDot.style.background = '#16a34a';
            setDemoWeather();
        }
    </script>
</body>
</html>
